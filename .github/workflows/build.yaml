name: Build macOS Installer ISO/DMG image

on:
  workflow_dispatch:
    inputs:
      macos_version:
        description: 'Select a macOS version to build'
        required: true
        type: choice
        options:
          - 'Tahoe'
          - 'Sequoia'
          - 'Sonoma'
          - 'Ventura'
          - 'Monterey'
          - 'Big Sur'
          - 'Catalina'
          - 'Mojave'
          - 'High Sierra'
      image_format:
        description: 'Select image format(s) to build'
        required: true
        type: choice
        default: 'both'
        options:
          - 'iso'
          - 'dmg'
          - 'both'

jobs:
  build-installer:
    runs-on: macos-15-intel
    timeout-minutes: 120
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: System Information
        run: |
          echo "Runner OS: $(sw_vers -productName) $(sw_vers -productVersion)"
          echo "Architecture: $(uname -m)"
          df -h

      - name: Fetch available macOS installers
        id: fetch_installers
        run: |
          echo "Fetching available installers..."
          softwareupdate --list-full-installers 2>/dev/null | grep "* Title:" | sed 's/^[[:space:]]*//' > installers.txt
          INSTALLER_VERSION=$(grep "${{ github.event.inputs.macos_version }}" installers.txt | head -1 | sed -n 's/.*Version: \([^,]*\).*/\1/p')
          echo "Found latest ${{ github.event.inputs.macos_version }} version: $INSTALLER_VERSION"
          echo "version=$INSTALLER_VERSION" >> $GITHUB_OUTPUT

      - name: Cache macOS Installer
        id: cache_installer
        uses: actions/cache@v4
        with:
          path: /Applications/Install macOS*.app
          key: ${{ runner.os }}-installer-${{ github.event.inputs.macos_version }}-${{ steps.fetch_installers.outputs.version }}

      - name: Download macOS installer
        id: download_installer
        if: steps.cache_installer.outputs.cache-hit != 'true'
        timeout-minutes: 60
        continue-on-error: true
        run: |
          echo "Installer not found in cache. Downloading..."
          RETRIES_COUNT=3
          for attempt in $(seq 1 $RETRIES_COUNT); do
            if softwareupdate --fetch-full-installer --full-installer-version "${{ steps.fetch_installers.outputs.version }}"; then
              echo "download_success=true" >> $GITHUB_OUTPUT; break
            fi
            if [ $attempt -eq $RETRIES_COUNT ]; then
              echo "download_success=false" >> $GITHUB_OUTPUT; exit 1
            fi
            sleep 5
          done

      - name: Check download status
        if: always()
        run: |
          if [ "${{ steps.cache_installer.outputs.cache-hit }}" != 'true' ] && [ "${{ steps.download_installer.outputs.download_success }}" != 'true' ]; then
            echo "download_failed=true" >> $GITHUB_ENV
          else
            echo "download_failed=false" >> $GITHUB_ENV
          fi

      - name: Create ISO Image
        if: success() && env.download_failed == 'false' && (github.event.inputs.image_format == 'iso' || github.event.inputs.image_format == 'both')
        run: |
          MACOS_NAME="${{ github.event.inputs.macos_version }}"
          MACOS_VERSION="${{ steps.fetch_installers.outputs.version }}"
          IMAGE_NAME_BASE="macOS-${MACOS_NAME}-${MACOS_VERSION}"
          IMAGE_FILE="${GITHUB_WORKSPACE}/${IMAGE_NAME_BASE}.iso"
          SPARSE_IMAGE="/tmp/${IMAGE_NAME_BASE}.sparseimage"
          INSTALLER_PATH="/Applications/Install macOS ${MACOS_NAME}.app"
          
          echo "Creating ISO image..."
          hdiutil create -size 20g -volname "macOS" -fs HFS+ -type SPARSE -attach "$SPARSE_IMAGE"
          DISK_ID=$(diskutil list | grep "macOS" | head -1 | awk '{print $NF}' | sed 's/s[0-9]*$//')
          sudo "$INSTALLER_PATH/Contents/Resources/createinstallmedia" --volume "/Volumes/macOS" --nointeraction
          sync && sleep 5
          hdiutil detach "$DISK_ID" -force
          sleep 2
          hdiutil makehybrid -hfs -udf -o "$IMAGE_FILE" "$SPARSE_IMAGE"
          
          if [ ! -f "$IMAGE_FILE" ]; then echo "Error: ISO file not created"; exit 1; fi
          echo "ISO created: $IMAGE_FILE"

      - name: Create DMG Image
        if: success() && env.download_failed == 'false' && (github.event.inputs.image_format == 'dmg' || github.event.inputs.image_format == 'both')
        run: |
          MACOS_NAME="${{ github.event.inputs.macos_version }}"
          MACOS_VERSION="${{ steps.fetch_installers.outputs.version }}"
          IMAGE_NAME_BASE="macOS-${MACOS_NAME}-${MACOS_VERSION}"
          IMAGE_FILE="${GITHUB_WORKSPACE}/${IMAGE_NAME_BASE}.dmg"
          INSTALLER_PATH="/Applications/Install macOS ${MACOS_NAME}.app"

          echo "Creating DMG image..."
          hdiutil create -size 20g -volname "macOS" -fs HFS+ -type UDIF -attach "$IMAGE_FILE"
          DISK_ID=$(diskutil list | grep "macOS" | head -1 | awk '{print $NF}' | sed 's/s[0-9]*$//')
          
          echo "Creating install media on DMG..."
          sudo "$INSTALLER_PATH/Contents/Resources/createinstallmedia" --volume "/Volumes/macOS" --nointeraction
          sync && sleep 5
          
          echo "Shrinking partition to consolidate data..."
          INSTALLER_PARTITION="${DISK_ID}s2"
          MIN_SIZE=$(diskutil resizeVolume "$INSTALLER_PARTITION" limits | grep "Minimum" | sed -n 's/.*(\([0-9]*\) Bytes).*/\1/p')
          diskutil resizeVolume "$INSTALLER_PARTITION" "${MIN_SIZE}B" free free 0
          sync && sleep 5
          
          echo "Detaching disk image..."
          hdiutil detach "$DISK_ID" -force
          sleep 2
          
          echo "Resizing DMG container to minimum size..."
          hdiutil resize -size min "$IMAGE_FILE"
          
          if [ ! -f "$IMAGE_FILE" ]; then echo "Error: DMG file not created"; exit 1; fi
          echo "DMG created: $IMAGE_FILE"
      
      - name: Upload ISO Artifact
        if: success() && env.download_failed == 'false' && (github.event.inputs.image_format == 'iso' || github.event.inputs.image_format == 'both')
        uses: actions/upload-artifact@v4
        with:
          name: macOS-${{ github.event.inputs.macos_version }}-${{ steps.fetch_installers.outputs.version }}-ISO
          path: ${{ github.workspace }}/*.iso
          retention-days: 7

      - name: Upload DMG Artifact
        if: success() && env.download_failed == 'false' && (github.event.inputs.image_format == 'dmg' || github.event.inputs.image_format == 'both')
        uses: actions/upload-artifact@v4
        with:
          name: macOS-${{ github.event.inputs.macos_version }}-${{ steps.fetch_installers.outputs.version }}-DMG
          path: ${{ github.workspace }}/*.dmg
          retention-days: 7

      - name: Final Summary
        if: always()
        run: |
          WORKFLOW_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          if [ "${{ job.status }}" == 'success' ] && [ "${{ env.download_failed }}" == 'false' ]; then
            echo "## ✅ Build Successful" >> $GITHUB_STEP_SUMMARY
            echo "The installer image(s) for **macOS ${{ github.event.inputs.macos_version }} (${{ steps.fetch_installers.outputs.version }})** have been successfully generated." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "You can download the generated file(s) from the 'Artifacts' section of this workflow run." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "➡️ **[View Workflow Run to Download Artifact(s)]($WORKFLOW_URL)**" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ env.download_failed }}" == 'true' ]; then
            echo "## ❌ Build Failed: Installer Download Error" >> $GITHUB_STEP_SUMMARY
            echo "> The macOS installer could not be downloaded from Apple's servers. This is often a temporary network issue with the GitHub runner. **Please re-run the workflow to try again.**" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ❌ Build Failed" >> $GITHUB_STEP_SUMMARY
            echo "> The workflow failed during the image creation or upload process. Please review the job logs for detailed error messages." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Clean up runner
        if: always()
        run: |
          echo "Cleaning up build artifacts..."
          sudo rm -rf "/Applications/Install macOS ${{ github.event.inputs.macos_version }}.app"
          rm -f "${{ github.workspace }}/*.iso"
          rm -f "${{ github.workspace }}/*.dmg"
          echo "Cleanup complete."
