name: Build macOS Installer ISO/DMG image

on:
  workflow_dispatch:
    inputs:
      macos_version:
        description: 'Select a macOS version to build'
        required: true
        type: choice
        options:
          - 'Tahoe'
          - 'Sequoia'
          - 'Sonoma'
          - 'Ventura'
          - 'Monterey'
          - 'Big Sur'
          - 'Catalina'
          - 'Mojave'
          - 'High Sierra'
      image_format:
        description: 'Select image format(s) to build'
        required: true
        type: choice
        default: 'both'
        options:
          - 'iso'
          - 'dmg'
          - 'both'

jobs:
  build-installer:
    runs-on: macos-15-intel
    timeout-minutes: 120
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: System Information
        run: |
          echo "Runner OS: $(sw_vers -productName) $(sw_vers -productVersion)"
          echo "Architecture: $(uname -m)"
          df -h

      - name: Fetch available macOS installers
        id: fetch_installers
        run: |
          echo "Fetching available installers..."
          softwareupdate --list-full-installers 2>/dev/null | grep "* Title:" | sed 's/^[[:space:]]*//' > installers.txt
          INSTALLER_VERSION=$(grep "${{ github.event.inputs.macos_version }}" installers.txt | head -1 | sed -n 's/.*Version: \([^,]*\).*/\1/p')
          echo "Found latest ${{ github.event.inputs.macos_version }} version: $INSTALLER_VERSION"
          echo "version=$INSTALLER_VERSION" >> $GITHUB_OUTPUT

      - name: Cache macOS Installer
        id: cache_installer
        uses: actions/cache@v4
        with:
          path: /Applications/Install macOS*.app
          key: ${{ runner.os }}-installer-${{ github.event.inputs.macos_version }}-${{ steps.fetch_installers.outputs.version }}

      - name: Download macOS installer
        id: download_installer
        if: steps.cache_installer.outputs.cache-hit != 'true'
        timeout-minutes: 60
        continue-on-error: true
        run: |
          echo "Installer not found in cache. Downloading..."
          RETRIES_COUNT=3
          for attempt in $(seq 1 $RETRIES_COUNT); do
            if softwareupdate --fetch-full-installer --full-installer-version "${{ steps.fetch_installers.outputs.version }}"; then
              echo "download_success=true" >> $GITHUB_OUTPUT; break
            fi
            if [ $attempt -eq $RETRIES_COUNT ]; then
              echo "download_success=false" >> $GITHUB_OUTPUT; exit 1
            fi
            sleep 5
          done

      - name: Check download status
        if: always()
        run: |
          if [ "${{ steps.cache_installer.outputs.cache-hit }}" != 'true' ] && [ "${{ steps.download_installer.outputs.download_success }}" != 'true' ]; then
            echo "download_failed=true" >> $GITHUB_ENV
          else
            echo "download_failed=false" >> $GITHUB_ENV
          fi

      - name: Create ISO Image
        id: create_iso
        if: success() && env.download_failed == 'false' && (github.event.inputs.image_format == 'iso' || github.event.inputs.image_format == 'both')
        run: |
          MACOS_NAME="${{ github.event.inputs.macos_version }}"
          MACOS_VERSION="${{ steps.fetch_installers.outputs.version }}"
          IMAGE_NAME_BASE="macOS-${MACOS_NAME}-${MACOS_VERSION}"
          IMAGE_FILE="${GITHUB_WORKSPACE}/${IMAGE_NAME_BASE}.iso"
          SPARSE_IMAGE="/tmp/${IMAGE_NAME_BASE}.sparseimage"
          INSTALLER_PATH="/Applications/Install macOS ${MACOS_NAME}.app"
          
          echo "Creating ISO image..."
          hdiutil create -size 20g -volname "macOS" -fs HFS+ -type SPARSE -attach "$SPARSE_IMAGE"
          DISK_ID=$(diskutil list | grep "macOS" | head -1 | awk '{print $NF}' | sed 's/s[0-9]*$//')
          sudo "$INSTALLER_PATH/Contents/Resources/createinstallmedia" --volume "/Volumes/macOS" --nointeraction
          sync && sleep 5
          hdiutil detach "$DISK_ID" -force
          sleep 2
          hdiutil makehybrid -hfs -udf -o "$IMAGE_FILE" "$SPARSE_IMAGE"
          
          if [ -f "$IMAGE_FILE" ]; then
            echo "ISO created: $IMAGE_FILE"
            echo "image_file=$IMAGE_FILE" >> $GITHUB_OUTPUT
          else
            echo "Error: ISO file not created"
            exit 1
          fi

      - name: Create DMG Image
        id: create_dmg
        if: success() && env.download_failed == 'false' && (github.event.inputs.image_format == 'dmg' || github.event.inputs.image_format == 'both')
        run: |
          MACOS_NAME="${{ github.event.inputs.macos_version }}"
          MACOS_VERSION="${{ steps.fetch_installers.outputs.version }}"
          IMAGE_NAME_BASE="macOS-${MACOS_NAME}-${MACOS_VERSION}"
          IMAGE_FILE="${GITHUB_WORKSPACE}/${IMAGE_NAME_BASE}.dmg"
          INSTALLER_PATH="/Applications/Install macOS ${MACOS_NAME}.app"

          echo "Creating DMG image..."
          hdiutil create -size 20g -volname "macOS" -fs HFS+ -type UDIF -attach "$IMAGE_FILE"
          DISK_ID=$(diskutil list | grep "macOS" | head -1 | awk '{print $NF}' | sed 's/s[0-9]*$//')
          sudo "$INSTALLER_PATH/Contents/Resources/createinstallmedia" --volume "/Volumes/macOS" --nointeraction
          sync && sleep 5
          INSTALLER_PARTITION="${DISK_ID}s2"
          MIN_SIZE=$(diskutil resizeVolume "$INSTALLER_PARTITION" limits | grep "Minimum" | sed -n 's/.*(\([0-9]*\) Bytes).*/\1/p')
          diskutil resizeVolume "$INSTALLER_PARTITION" "${MIN_SIZE}B" free free 0
          sync && sleep 5
          diskutil resizeVolume "$INSTALLER_PARTITION" 0
          sync && sleep 5
          hdiutil detach "$DISK_ID" -force
          sleep 2
          hdiutil resize -size min "$IMAGE_FILE"
          
          if [ -f "$IMAGE_FILE" ]; then
            echo "DMG created: $IMAGE_FILE"
            echo "image_file=$IMAGE_FILE" >> $GITHUB_OUTPUT
          else
            echo "Error: DMG file not created"
            exit 1
          fi

      - name: Prepare Release Assets
        id: prepare_assets
        if: success() && env.download_failed == 'false'
        run: |
          ASSET_PATHS=""
          if [ -f "${{ steps.create_iso.outputs.image_file }}" ]; then
            ASSET_PATHS="${{ steps.create_iso.outputs.image_file }}"
          fi
          if [ -f "${{ steps.create_dmg.outputs.image_file }}" ]; then
            if [ -z "$ASSET_PATHS" ]; then
              ASSET_PATHS="${{ steps.create_dmg.outputs.image_file }}"
            else
              ASSET_PATHS="${ASSET_PATHS}
          ${{ steps.create_dmg.outputs.image_file }}"
            fi
          fi
          echo "Assets to be uploaded:"
          echo "$ASSET_PATHS"
          echo "asset_paths=$ASSET_PATHS" >> $GITHUB_OUTPUT

      - name: Prepare Release Information
        id: prepare_release
        if: steps.prepare_assets.outputs.asset_paths != ''
        run: |
          export RELEASE_BODY="
          ## macOS ${{ github.event.inputs.macos_version }} Installers

          This release contains bootable installer images for macOS ${{ github.event.inputs.macos_version }}.

          ### Asset Types
          - **\`.iso\` files:** For use in virtual machines (Proxmox, VMware, VirtualBox, QEMU). Attach the ISO to a virtual CD/DVD drive to begin installation.
          - **\`.dmg\` files:** For creating physical bootable USB drives. Please read the instructions below carefully based on your target hardware.

          ---

          ### Creating a Bootable USB from a DMG

          #### For Apple Hardware (Macs)
          This method is for creating an installer to use on a genuine Apple Mac.
          > **:warning: DANGER:** This is a destructive operation that will erase the contents of your USB drive. Double-check the disk identifier.
          > 1.  **Identify your USB drive:** On your Mac or Linux machine, run \`diskutil list\` or \`lsblk\`.
          > 2.  **Unmount the drive:** \`diskutil unmountDisk /dev/diskX\` (replace \`X\` with your disk number).
          > 3.  **Write the image:** \`sudo dd if=/path/to/your.dmg of=/dev/rdiskX bs=1m\` (using \`rdisk\` on macOS is faster).

          #### For Non-Apple Hardware (PCs / \"Hackintosh\")
          **Important:** Non-Apple hardware cannot boot the macOS installer directly. A specialized bootloader is required.
          
          > The process involves writing this DMG to a USB and adding a custom-built **OpenCore EFI** configuration. The DMG provides the macOS installer files; OpenCore makes them bootable on your PC.

          **Process Overview:**
          1.  **Write DMG to USB:** Use a tool like [Rufus](https://rufus.ie/) or [balenaEtcher](https://www.balena.io/etcher/) to write this \`.dmg\` file to your USB drive.
          2.  **Build Your OpenCore EFI:** You must create an EFI configuration specific to your PC's hardware (CPU, motherboard, GPU). We strongly recommend following the official **[Dortania's OpenCore Install Guide](https://dortania.github.io/OpenCore-Install-Guide/)**. Do not use pre-built EFIs from the internet.
          3.  **Deploy EFI to USB:** Mount the EFI partition of your USB drive and copy your custom \`EFI\` folder into it.
          "
          echo "$RELEASE_BODY" > release_notes.md
          echo "body_path=release_notes.md" >> $GITHUB_OUTPUT

      - name: Generate Release Tag
        id: release_info
        if: steps.prepare_assets.outputs.asset_paths != ''
        run: |
          echo "tag_name=$(echo '${{ github.event.inputs.macos_version }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Create and Upload Release Asset
        id: create_release
        uses: softprops/action-gh-release@v2
        if: steps.prepare_assets.outputs.asset_paths != ''
        with:
          name: macOS ${{ github.event.inputs.macos_version }} Installers
          tag_name: ${{ steps.release_info.outputs.tag_name }}
          body_path: ${{ steps.prepare_release.outputs.body_path }}
          files: ${{ steps.prepare_assets.outputs.asset_paths }}

      - name: Final Summary
        if: always()
        run: |
          if [ "${{ job.status }}" == 'success' ] && [ "${{ env.download_failed }}" == 'false' ]; then
            echo "## ✅ Build Successful" >> $GITHUB_STEP_SUMMARY
            echo "The installer image(s) for **macOS ${{ github.event.inputs.macos_version }} (${{ steps.fetch_installers.outputs.version }})** have been successfully generated and uploaded." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "➡️ **[View the release to download the asset(s)](${{ steps.create_release.outputs.html_url }})**" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ env.download_failed }}" == 'true' ]; then
            echo "## ❌ Build Failed: Installer Download Error" >> $GITHUB_STEP_SUMMARY
            echo "> The macOS installer could not be downloaded from Apple's servers. This is often a temporary network issue with the GitHub runner. **Please re-run the workflow to try again.**" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ❌ Build Failed" >> $GITHUB_STEP_SUMMARY
            echo "> The workflow failed during the image creation or upload process. Please review the job logs for detailed error messages." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Clean up runner
        if: always()
        run: |
          echo "Cleaning up build artifacts..."
          sudo rm -rf "/Applications/Install macOS ${{ github.event.inputs.macos_version }}.app"
          rm -f "${{ github.workspace }}/*.iso"
          rm -f "${{ github.workspace }}/*.dmg"
          echo "Cleanup complete."
